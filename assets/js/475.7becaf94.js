(window.webpackJsonp=window.webpackJsonp||[]).push([[475],{870:function(e,t,s){"use strict";s.r(t);var a=s(46),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"vue-compiler-sfc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#vue-compiler-sfc"}},[e._v("#")]),e._v(" @vue/compiler-sfc")]),e._v(" "),s("blockquote",[s("p",[e._v("Lower level utilities for compiling Vue Single File Components")])]),e._v(" "),s("p",[e._v("This package contains lower level utilities that you can use if you are writing a plugin / transform for a bundler or module system that compiles Vue Single File Components (SFCs) into JavaScript. It is used in "),s("a",{attrs:{href:"https://github.com/vuejs/vue-loader",target:"_blank",rel:"noopener noreferrer"}},[e._v("vue-loader"),s("OutboundLink")],1),e._v(", "),s("a",{attrs:{href:"https://github.com/vuejs/rollup-plugin-vue",target:"_blank",rel:"noopener noreferrer"}},[e._v("rollup-plugin-vue"),s("OutboundLink")],1),e._v(" and "),s("a",{attrs:{href:"https://github.com/vitejs/vite",target:"_blank",rel:"noopener noreferrer"}},[e._v("vite"),s("OutboundLink")],1),e._v(".")]),e._v(" "),s("h2",{attrs:{id:"browser-build-notes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#browser-build-notes"}},[e._v("#")]),e._v(" Browser Build Notes")]),e._v(" "),s("p",[e._v("The browser build relies on a browser-bundled build of "),s("code",[e._v("postcss")]),e._v(" to be available under the global "),s("code",[e._v("postcss")]),e._v(" (since it can't be properly bundled by Rollup).")]),e._v(" "),s("h2",{attrs:{id:"api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#api"}},[e._v("#")]),e._v(" API")]),e._v(" "),s("p",[e._v("The API is intentionally low-level due to the various considerations when integrating Vue SFCs in a build system:")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("Separate hot-module replacement (HMR) for script, template and styles")]),e._v(" "),s("ul",[s("li",[e._v("template updates should not reset component state")]),e._v(" "),s("li",[e._v("style updates should be performed without component re-render")])])]),e._v(" "),s("li",[s("p",[e._v("Leveraging the tool's plugin system for pre-processor handling. e.g. "),s("code",[e._v('<style lang="scss">')]),e._v(" should be processed by the corresponding webpack loader.")])]),e._v(" "),s("li",[s("p",[e._v("In some cases, transformers of each block in an SFC do not share the same execution context. For example, when used with "),s("code",[e._v("thread-loader")]),e._v(" or other parallelized configurations, the template sub-loader in "),s("code",[e._v("vue-loader")]),e._v(" may not have access to the full SFC and its descriptor.")])])]),e._v(" "),s("p",[e._v('The general idea is to generate a facade module that imports the individual blocks of the component. The trick is the module imports itself with different query strings so that the build system can handle each request as "virtual" modules:')]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("                                  +--------------------+\n                                  |                    |\n                                  |  script transform  |\n                           +-----\x3e+                    |\n                           |      +--------------------+\n                           |\n+--------------------+     |      +--------------------+\n|                    |     |      |                    |\n|  facade transform  +-----------\x3e+ template transform |\n|                    |     |      |                    |\n+--------------------+     |      +--------------------+\n                           |\n                           |      +--------------------+\n                           +-----\x3e+                    |\n                                  |  style transform   |\n                                  |                    |\n                                  +--------------------+\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br")])]),s("p",[e._v("Where the facade module looks like this:")]),e._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// main script")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" script "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("from")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/project/foo.vue?vue&type=script'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// template compiled to render function")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" render "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("from")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/project/foo.vue?vue&type=template&id=xxxxxx'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// css")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/project/foo.vue?vue&type=style&index=0&id=xxxxxx'")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// attach render function to script")]),e._v("\nscript"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("render "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" render\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// attach additional metadata")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// some of these should be dev only")]),e._v("\nscript"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("__file "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'example.vue'")]),e._v("\nscript"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("__scopeId "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'xxxxxx'")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// additional tooling-specific HMR handling code")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// using __VUE_HMR_API__ global")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("default")]),e._v(" script\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br")])]),s("h3",{attrs:{id:"high-level-workflow"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#high-level-workflow"}},[e._v("#")]),e._v(" High Level Workflow")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("In facade transform, parse the source into descriptor with the "),s("code",[e._v("parse")]),e._v(" API and generate the above facade module code based on the descriptor;")])]),e._v(" "),s("li",[s("p",[e._v("In script transform, use "),s("code",[e._v("compileScript")]),e._v(" to process the script. This handles features like "),s("code",[e._v("<script setup>")]),e._v(" and CSS variable injection. Alternatively, this can be done directly in the facade module (with the code inlined instead of imported), but it will require rewriting "),s("code",[e._v("export default")]),e._v(" to a temp variable (a "),s("code",[e._v("rewriteDefault")]),e._v(" convenience API is provided for this purpose) so additional options can be attached to the exported object.")])]),e._v(" "),s("li",[s("p",[e._v("In template transform, use "),s("code",[e._v("compileTemplate")]),e._v(" to compile the raw template into render function code.")])]),e._v(" "),s("li",[s("p",[e._v("In style transform, use "),s("code",[e._v("compileStyle")]),e._v(" to compile raw CSS to handle "),s("code",[e._v("<style scoped>")]),e._v(", "),s("code",[e._v("<style module>")]),e._v(" and CSS variable injection.")])])]),e._v(" "),s("p",[e._v("Options needed for these APIs can be passed via the query string.")]),e._v(" "),s("p",[e._v("For detailed API references and options, check out the source type definitions. For actual usage of these APIs, check out "),s("a",{attrs:{href:"https://github.com/vuejs/rollup-plugin-vue/tree/next",target:"_blank",rel:"noopener noreferrer"}},[e._v("rollup-plugin-vue"),s("OutboundLink")],1),e._v(" or "),s("a",{attrs:{href:"https://github.com/vuejs/vue-loader/tree/next",target:"_blank",rel:"noopener noreferrer"}},[e._v("vue-loader"),s("OutboundLink")],1),e._v(".")])])}),[],!1,null,null,null);t.default=n.exports}}]);