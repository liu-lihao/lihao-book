(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{383:function(s,n,a){s.exports=a.p+"assets/img/image.fab16997.png"},384:function(s,n,a){s.exports=a.p+"assets/img/image2.560710c1.png"},385:function(s,n,a){s.exports=a.p+"assets/img/image3.4be9836e.png"},386:function(s,n,a){s.exports=a.p+"assets/img/image4.7d5a3721.png"},387:function(s,n,a){s.exports=a.p+"assets/img/image5.37f6c7ce.png"},388:function(s,n,a){s.exports=a.p+"assets/img/image6.5ed76eb3.png"},389:function(s,n,a){s.exports=a.p+"assets/img/image7.d5f5f564.png"},390:function(s,n,a){s.exports=a.p+"assets/img/image8.8e7e8810.png"},391:function(s,n,a){s.exports=a.p+"assets/img/image9.c8be8362.png"},392:function(s,n,a){s.exports=a.p+"assets/img/image10.aaf010e2.png"},393:function(s,n,a){s.exports=a.p+"assets/img/image11.a2d52708.png"},539:function(s,n,a){"use strict";a.r(n);var t=a(46),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"从零开始教你用-docker-部署-jenkins-为你的项目实现ci-cd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从零开始教你用-docker-部署-jenkins-为你的项目实现ci-cd"}},[s._v("#")]),s._v(" 从零开始教你用 Docker 部署 Jenkins，为你的项目实现CI/CD")]),s._v(" "),t("p",[s._v("本文适合尚未了解 Docker 或 Jenkins 的人群，将介绍如何使用 Docker 搭建Gilab代码仓库和Jenkins，并以前端项目、Gitlab作为代码仓库为例，实现开发人员提交代码后，根据不同分支，自动构建项目，并部署至对应环境。实际上任何项目、任意主流代码仓库（如：gitlab、github、gitee、bitbucket等）皆可。\n​\n阅读本文，只需要你")]),s._v(" "),t("ul",[t("li",[s._v("会使用百度（or Google）和 git 克隆、提交代码，")]),s._v(" "),t("li",[s._v("了解 Web前端 的部署，是将 html 上传至 nginx 映射的目录")]),s._v(" "),t("li",[s._v("了解 linux 常用操作（如："),t("code",[s._v("cd、ls、cat、echo、ssh")]),s._v(" 等 ）即可")])]),s._v(" "),t("h2",{attrs:{id:"什么是ci-cd-jenkins能做什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是ci-cd-jenkins能做什么"}},[s._v("#")]),s._v(" 什么是CI/CD，Jenkins能做什么")]),s._v(" "),t("p",[s._v("实际开发中，经常会出现多分支并行开发，并需部署至多个环境，如果这些操作都有专人或者开发人员自己处理，那毫无疑问是巨大、且重复的工作量。在程序员的世界，重复的工作东西就应该自动化 ，而 Jenkins 就是为 "),t("strong",[s._v("持续构建（持续集成，CI）")]),s._v(" 、 "),t("strong",[s._v("持续部署（持续交付，CD）")]),s._v(" 的 "),t("strong",[s._v("自动化、可视化")]),s._v(" 操作提供解决方案。\n​")]),s._v(" "),t("p",[s._v("通俗的说，整个流程通过 【git仓库通过提交代码触发Hook通知Jenkins】或者【Jenkins 轮询扫描检查更新】等...，触发相关任务或流水线的脚本的执行。而 Jenkins 仅作为触发器、可视化的工具，相关的构建、部署都需要自行通过脚本实现。如：shell、nodejs、python 等。")]),s._v(" "),t("h2",{attrs:{id:"为什么用到了-docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么用到了-docker"}},[s._v("#")]),s._v(" 为什么用到了 Docker")]),s._v(" "),t("p",[s._v("Docker 可以理解为 linux 的虚拟机管理工具，可以方便、快速的创建一个虚拟机（更准确是叫 "),t("strong",[s._v("容器")]),s._v("：Docker Container），如 Alpine Linux 仅有5mb大小。\n​")]),s._v(" "),t("p",[s._v("将代码和一些服务，跑在同一个版本的容器中，可以 "),t("strong",[s._v("确保环境一致")]),s._v(" ，而不受硬件、机器本身操作系统影响，这在服务器迁移、分布式部署、构建等场景非常有用。换句话说，通过容器跑的项目， "),t("strong",[s._v("可以迁移、部署任意一台安装了 Docker 服务器上")]),s._v(" ，而几乎没有风险，只需要拉取同样的容器即可。\n​")]),s._v(" "),t("p",[s._v("Docker 既然如此重要，很有必要先简单的了解一下：（自行搜索适合自己系统安装 Docker 的方式）")]),s._v(" "),t("h3",{attrs:{id:"docker-基本概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-基本概念"}},[s._v("#")]),s._v(" Docker 基本概念")]),s._v(" "),t("p",[t("img",{attrs:{src:a(383),alt:"image.png"}})]),s._v(" "),t("ul",[t("li",[s._v("宿主机从仓库 pull 一个镜像，然后 run 起来，就是一个容器（虚拟机）了")]),s._v(" "),t("li",[s._v("进入容器一顿操作后，可以通过 commit 将更改留在镜像，否则容器停止后更改不会保留")]),s._v(" "),t("li",[s._v("镜像可以 save 出一个文件，方便迁移")]),s._v(" "),t("li",[s._v("Dockerfile 可以仅用一个文件配置的方式来定制出一个镜像，而tag文件则是一个完整的操作系统了。")])]),s._v(" "),t("blockquote",[t("p",[s._v("docker 默认连接的官方仓库是 "),t("a",{attrs:{href:"https://hub.docker.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://hub.docker.com/"),t("OutboundLink")],1),s._v(" ，可以进入搜索 alpine 试试。")])]),s._v(" "),t("h3",{attrs:{id:"docker-基本操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-基本操作"}},[s._v("#")]),s._v(" Docker 基本操作")]),s._v(" "),t("p",[s._v("拉取镜像 -> 创建容器 -> 进入容器 -> 操作容器  -> 删除容器 -> 删除镜像")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拉取 nginx:alpine 镜像，不带版本号默认latest最新版本，实际项目上强烈建议固定版本")]),s._v("\n$ docker pull nginx:alpine\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看当前有哪些镜像（可以查看 IMAGE_ID 等）")]),s._v("\n$ docker images\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将镜像运行为容器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -d 后台运行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p 8080:80 端口映射（port），前者为宿主机端口，后者为容器端口")]),s._v("\n$ docker run -d -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 nginx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此时宿主机 8080 端口已经可以查看到 👉 nginx 的欢迎页。")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看运行镜像（可以查看 CONTAINER_ID 、CONTAINER_NAME 等）")]),s._v("\n$ docker "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以再次运行，即镜像创建第二个容器（实例，运行与第一个相互隔离，且独立的系统）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自己准备一个 index.html 文件，然后将其目录与下方的 “/YOUR_HTML_DIR” 替换")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -v /YOUR_HTML_DIR:/usr/share/nginx/html 目录映射（volume），前者为宿主机目录，后者为容器目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --name my_html_nginx 给容器起个名字，可用来代替 CONTAINER_ID")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当然，8080 端口被占用了，这里用 8081 端口。")]),s._v("\n$ docker run -d -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(":80 nginx -v /YOUR_HTML_DIR:/usr/share/nginx/html --name my_html_nginx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此时宿主机 8081 端口已经可以查看到 👉 自己准备的 html 文件")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入容器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# my_html_nginx 为 CONTAINER_NAME")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 也可以用 CONTAINER_ID, 使用任意能唯一匹配的长度即可")]),s._v("\n$ docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it my_html_nginx "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以 `cd /usr/share/nginx/html` 看看自己的html文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当然也可以通过 vi 修改 html 文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出容器")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除容器")]),s._v("\n$ docker "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f /*CONTAINER_ID*/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除镜像")]),s._v("\n$ docker rmi -f /*IMAGE_ID*/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")])]),t("p",[s._v("如果要求容器需要自带一些自己定制的一些工具和配置，此时建议使用 "),t("code",[s._v("Dockerfile")]),s._v(" 来定制构建镜像，下面举个简单的例子，感兴趣的可以去搜索相关语法。")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VOLUME")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/YOUR_HTML_DIR"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/share/nginx/html"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# build 出镜像后，run 时，仍需 -p 指定端口映射")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8081\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("将该 Dockerfile 写入到一个空目录。并 "),t("code",[s._v("cd")]),s._v(" 到该目录 ，执行： "),t("code",[s._v("docker build -t name1:tag1 .")]),s._v("（注意后面有个点），就可以通过 "),t("code",[s._v("docker images")]),s._v(" 查看到构建出的 镜像。")]),s._v(" "),t("h3",{attrs:{id:"docker-compose"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose"}},[s._v("#")]),s._v(" Docker Compose")]),s._v(" "),t("p",[s._v("可以通过 "),t("code",[s._v("docker run")]),s._v(" 跑起容器，需要大量配置参数支撑，都写成命令参数可读性非常差。此外，容器间相互通信也将成为障碍。")]),s._v(" "),t("blockquote",[t("ol",[t("li",[s._v("为什么会有障碍？")])]),s._v(" "),t("p",[s._v("答：Docker 网卡会为每个容器分配一个内网 ip，但是容器之间并不知道对方会被分配到什么 ip\n​")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("上述_ Docker 基本操作 _中，第二个启动的 "),t("code",[s._v("my_html_nginx")]),s._v(" 容器，能通过 "),t("code",[s._v("127.0.0.1:8080")]),s._v(" 访问到第一个启动的容器吗？")])]),s._v(" "),t("p",[s._v("答：不能，"),t("code",[s._v("127.0.0.1")]),s._v(" 指向容器本身，而非宿主机，应该通过docker "),t("strong",[s._v("内网 ip")]),s._v(" 访问其 "),t("strong",[s._v("本身的端口")]),s._v("，如 "),t("code",[s._v("172.17.0.2:80")]),s._v(" ，而不是 外部的 8080。\n​")]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("怎么查看容器的被分配的内网 ip？")])]),s._v(" "),t("p",[s._v("答："),t("code",[s._v("ifconfig")]),s._v(" or  查看hosts "),t("code",[s._v("cat /etc/hosts")])])]),s._v(" "),t("p",[s._v("那么容器与容器之间怎么通信呢？")]),s._v(" "),t("ol",[t("li",[s._v("手动查看每个容器 ip，修改每个容器 hosts【非常不实用】")]),s._v(" "),t("li",[s._v("使用 "),t("code",[s._v("--link")]),s._v("，但只能单向通信："),t("code",[s._v("run")]),s._v(" 时使用 "),t("code",[s._v("--link /* CONTAINER_ID:HOST_NAME */")]),s._v(" ，在这个刚起的容器内，可以通过 HOST_NAME 访问该 CONTAINER_ID 的容器，而该 CONTAINER_ID 容器，无法访问到这个刚起的容器。【非常不实用】")]),s._v(" "),t("li",[s._v("通过 docker-compose 编排容器，是通过一个 yml 文件，就能运行多个容器的神器。其会自动的将定义容器的 "),t("code",[s._v("key")]),s._v(" 值，作为每个容器的域名映射。当然了，docker-compose 需自行搜索安装方式。")])]),s._v(" "),t("p",[s._v("下面举个简单的例子，"),t("code",[s._v("nginx01")]),s._v(" 和 "),t("code",[s._v("nginx02")]),s._v(" 作为容器的 "),t("code",[s._v("key")]),s._v(" 值。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nginx01")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mynginx01\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 8080"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nginx02")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mynginx02\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 8081"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将上述配置保存为 docker-compose.yml 文件，并cd到该目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 docker-compose ，up 启动，-d 是后台运行")]),s._v("\n$ docker-compose up -d\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入容器 mynginx02")]),s._v("\n$ docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mynginx02 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果没有 curl ，则执行 apk add curl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果有就尝试连接一下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以看到返回一个 nginx01 的欢迎页")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" nginx02:80\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意不是 8080")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("​\n到此，相信你已经基本会使用 Docker、docker-compose 了，下面回到主题")]),s._v(" "),t("h2",{attrs:{id:"硬件环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#硬件环境"}},[s._v("#")]),s._v(" 硬件环境")]),s._v(" "),t("p",[s._v("理论上，需要三台服务器。但因为笔者资金有限，仅有一台电脑，通过三个 Docker 容器（虚拟机），代替三台服务器\n三台服务器的作用是分别部署：")]),s._v(" "),t("ul",[t("li",[s._v("gitlab：代码仓库")]),s._v(" "),t("li",[s._v("jenkins：主流的 CI/CD 工具")]),s._v(" "),t("li",[s._v("nginx：作为项目部署的服务器，此处用不同目录代表不同环境（模拟实际项目上，不同环境对应不同服务器）。")])]),s._v(" "),t("p",[s._v("笔者电脑：win10 20H2 wsl2 Ubuntu 20.04.2 LTS、Docker version 20.10.6、docker-compose version 1.29.2（硬件要求：内存16g以上，其余环境只要有了docker，就无所谓了）")]),s._v(" "),t("h2",{attrs:{id:"部署-gitlab、jenkins、nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-gitlab、jenkins、nginx"}},[s._v("#")]),s._v(" 部署 gitlab、jenkins、nginx")]),s._v(" "),t("h3",{attrs:{id:"部署脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署脚本"}},[s._v("#")]),s._v(" 部署脚本")]),s._v(" "),t("p",[s._v("使用docker，分别创建三台服务器，并且这三台服务器之间还需要通信，所以用到 docker-compose 来编排容器。（如果你有三台服务器，则可分开部署，通过服务器之间通过内网ip访问即可）")]),s._v(" "),t("p",[s._v("创建脚本如下：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("version: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\nservices:\n  nginx:\n    container_name: mynginx\n    image: nginx:alpine\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80\n      - "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8022:22"')]),s._v("\n    volumes:\n      - /home/vito/project:/usr/share/nginx/html\n      - /home/vito/docker_nginx_data/log:/var/log/nginx\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按需配置，如果你了解 nginx 的话")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# - /home/vito/docker_nginx_data/nginx.conf:/etc/nginx/nginx.conf")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# - /home/vito/docker_nginx_data/conf.d/default.conf:/etc/nginx/conf.d/default.conf")]),s._v("\n    command:\n      - /bin/sh\n      - -c\n      - "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://mirrors.aliyun.com/alpine/v3.8/main/"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/apk/repositories\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://mirrors.aliyun.com/alpine/v3.8/community/"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/apk/repositories\n        apk update\n        apk "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" --no-cache openssh openrc tzdata\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/#PermitRootLogin.*/PermitRootLogin yes/g"')]),s._v(" /etc/ssh/sshd_config\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /root/.ssh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("700")]),s._v(" /root/.ssh/\n        ssh-keygen -A\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root:root"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" chpasswd\n        apk del tzdata\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /var/cache/apk/*\n        /usr/sbin/sshd\n        nginx\n        nginx -s reload\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" -f /dev/null\n  gitlab:\n    container_name: mygitlab\n    image: gitlab/gitlab-ce:latest\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6490")]),s._v(":80\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6492")]),s._v(":443\n    privileged: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    volumes:\n      - /home/vito/docker_gitlab_data/etc:/etc/gitlab\n      - /home/vito/docker_gitlab_data/log:/var/log/gitlab\n      - /home/vito/docker_gitlab_data/opt:/var/opt/gitlab\n  jenkins:\n    container_name: myjenkins\n    image: jenkins/jenkins:lts\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6480")]),s._v(":8080\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6481")]),s._v(":50000\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6482")]),s._v(":45000\n    volumes:\n      - /home/vito/docker_jenkins_data:/var/jenkins_home\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br")])]),t("p",[s._v("保存为 "),t("code",[s._v("docker-compose.yml")]),s._v(" 文件，通过 "),t("code",[s._v("docker-compose up -d")]),s._v(" 启动。\n"),t("strong",[s._v("注意")]),s._v("：")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("8022:22")]),s._v(" 需要加上引号，不然和yml语法有冲突")]),s._v(" "),t("li",[s._v("nginx command 会覆盖原命令，所以在安装、运行ssh后，还需要重启nginx")]),s._v(" "),t("li",[s._v('安装ssh，明文在脚本写了"root:root" (用户名:密码)，虽然不太对，但这里仅用来学习，且作为测试环境服务器')])]),s._v(" "),t("h3",{attrs:{id:"部署结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署结果"}},[s._v("#")]),s._v(" 部署结果")]),s._v(" "),t("p",[s._v("项目分别部署在（根据端口映射，且需要在宿主机补充一个页面，/home/vito/project/k/index.html）：")]),s._v(" "),t("ul",[t("li",[s._v("Ngnix 前端项目："),t("a",{attrs:{href:"http://127.0.0.1/k/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://127.0.0.1/k/index.html"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("Gitlab: "),t("a",{attrs:{href:"http://127.0.0.1:6490",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://127.0.0.1:6490"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("Jenkins: "),t("a",{attrs:{href:"http://127.0.0.1:6480",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://127.0.0.1:6480"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"初始化-gitlab、jenkins、nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#初始化-gitlab、jenkins、nginx"}},[s._v("#")]),s._v(" 初始化 gitlab、jenkins、nginx")]),s._v(" "),t("p",[s._v("打开 Gitlab、Jenkins 瞧一瞧，该设密码就设密码，该创建账户就创建，根据 UI 提示操作即可。\n这里需要"),t("strong",[s._v("注意")])]),s._v(" "),t("ul",[t("li",[s._v("gitlab初始账户名称是：root")]),s._v(" "),t("li",[s._v("jenkins安装 "),t("strong",[s._v("推荐插件")])])]),s._v(" "),t("h3",{attrs:{id:"gitlab"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab"}},[s._v("#")]),s._v(" gitlab")]),s._v(" "),t("h4",{attrs:{id:"初始化项目代码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#初始化项目代码"}},[s._v("#")]),s._v(" 初始化项目代码")]),s._v(" "),t("p",[s._v("此处需要您创建了一个 test-vite 的项目："),t("code",[s._v("ssh://git@127.0.*.*:***/test/test-vite.git")])]),s._v(" "),t("p",[s._v("并通过 "),t("code",[s._v("yarn create @vitejs/app")]),s._v(" 初始化了前端代码")]),s._v(" "),t("h4",{attrs:{id:"webhook请求配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webhook请求配置"}},[s._v("#")]),s._v(" webhook请求配置")]),s._v(" "),t("p",[s._v("使用root账户进行设置（如果你将gitlab部署到另一台服务器，这里就可以略过了）：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(384),alt:"image.png"}}),s._v("\n​")]),s._v(" "),t("h3",{attrs:{id:"jenkins"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jenkins"}},[s._v("#")]),s._v(" jenkins")]),s._v(" "),t("h4",{attrs:{id:"插件安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#插件安装"}},[s._v("#")]),s._v(" 插件安装")]),s._v(" "),t("p",[s._v("手动搜索安装：")]),s._v(" "),t("ul",[t("li",[s._v("gitlab")]),s._v(" "),t("li",[s._v("nodejs")])]),s._v(" "),t("h4",{attrs:{id:"系统设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统设置"}},[s._v("#")]),s._v(" 系统设置")]),s._v(" "),t("p",[s._v("系统设置 - 系统配置")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("取消打勾 Gitlab：Enable authentication for '/project' end-point")])])]),s._v(" "),t("p",[s._v("系统设置 - 全局工具配置")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("安装Nodejs。Global npm packages to install 此处可以填写 yarn（根据项目来，也可以不填，手动通过npm安装）")])])]),s._v(" "),t("h4",{attrs:{id:"配置-gitlab-拉取代码权限认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-gitlab-拉取代码权限认证"}},[s._v("#")]),s._v(" 配置 gitlab 拉取代码权限认证")]),s._v(" "),t("p",[s._v("当然了，此时的 jenkins 肯定是匿名，没有权限拉取代码的。分别给 jenkins、gitlab 配个 ssh 私钥、公钥即可。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(385),alt:"image.png"}})]),s._v(" "),t("h4",{attrs:{id:"生成公钥、私钥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生成公钥、私钥"}},[s._v("#")]),s._v(" 生成公钥、私钥")]),s._v(" "),t("p",[s._v("进入jenkins容器，使用root账号生成："),t("code",[s._v("ssh-keygen -t rsa")])]),s._v(" "),t("p",[s._v("一路回车，进入提示的目录就可以看到，两个文件：")]),s._v(" "),t("ul",[t("li",[s._v("id_rsa 私钥")]),s._v(" "),t("li",[s._v("id_rsa.pub 公钥")])]),s._v(" "),t("p",[s._v("分别 "),t("code",[s._v("cat")]),s._v(" 出来，并复制。")]),s._v(" "),t("h5",{attrs:{id:"配置公钥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置公钥"}},[s._v("#")]),s._v(" 配置公钥")]),s._v(" "),t("p",[s._v("gitlab -> 头像 -> preferences -> ssh 密钥 -> 粘贴公钥 -> 添加密钥")]),s._v(" "),t("h5",{attrs:{id:"配置私钥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置私钥"}},[s._v("#")]),s._v(" 配置私钥")]),s._v(" "),t("p",[s._v("jenkins -> 系统管理 -> 凭据管理（Manage Credentails，不是凭据配置） -> 添加全局凭据 -> 选择 SSH... -> 如图")]),s._v(" "),t("p",[t("img",{attrs:{src:a(386),alt:"image.png"}})]),s._v(" "),t("h4",{attrs:{id:"配置-nginx-推送文件的-ssh-免密"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-nginx-推送文件的-ssh-免密"}},[s._v("#")]),s._v(" 配置 nginx 推送文件的 ssh 免密")]),s._v(" "),t("p",[s._v("用于 jenkins 执行推送文件脚本，同步文件到nginx服务器上。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入jenkins")]),s._v("\ndocker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it myjenkins "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入后")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1、生成公钥、私钥")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    一路回车")]),s._v("\nssh-keygen\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2、添加公钥，这里需要输入ngnix服务器的密码，就是上方脚本里头的root:root，前者为用户名，后者为密码。")]),s._v("\nssh-copy-id -i ~/.ssh/id_rsa.pub root@nginx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 完成免密，测试")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("blockquote",[t("p",[s._v("补充知识：ssh默认会连22端口，对于本来就暴露22端口的nginx容器来说无需配置，而对于外部的宿主机就需要指定映射的端口："),t("code",[s._v("ssh root@127.0.0.1 -p8022")])])]),s._v(" "),t("h2",{attrs:{id:"实现-ci-cd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现-ci-cd"}},[s._v("#")]),s._v(" 实现 CI/CD")]),s._v(" "),t("p",[s._v("下面介绍Jenkins创建项目中最常用的两种方式，其中主流还是 pipeline。")]),s._v(" "),t("h3",{attrs:{id:"方式1-通过-jenkins-freestyle"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方式1-通过-jenkins-freestyle"}},[s._v("#")]),s._v(" 方式1：通过 Jenkins Freestyle")]),s._v(" "),t("p",[s._v("自由风格非常简单：jenkins提供一个工作空间，通过ui配置shell")]),s._v(" "),t("h4",{attrs:{id:"源码配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#源码配置"}},[s._v("#")]),s._v(" 源码配置：")]),s._v(" "),t("ul",[t("li",[s._v("源码地址ip需替换为映射地址")]),s._v(" "),t("li",[s._v("Credentials 凭证，选取刚刚配置好的")])]),s._v(" "),t("p",[t("img",{attrs:{src:a(387),alt:"image.png"}})]),s._v(" "),t("h4",{attrs:{id:"构建触发器-配合webhook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建触发器-配合webhook"}},[s._v("#")]),s._v(" 构建触发器（配合webHook）：")]),s._v(" "),t("p",[s._v("生成hook密钥，此时需要复制出：第一个红框的项目地址，以及生成的token。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(388),alt:"image.png"}})]),s._v(" "),t("p",[s._v("进入Gitlab test-vite 项目中：")]),s._v(" "),t("p",[t("strong",[s._v("注意")]),s._v("：项目地址ip需替换为映射地址：http://jenkins:8080/project/FE/gitlab-test-01")]),s._v(" "),t("p",[t("img",{attrs:{src:a(389),alt:"image.png"}})]),s._v(" "),t("p",[t("img",{attrs:{src:a(390),alt:"image.png"}})]),s._v(" "),t("h4",{attrs:{id:"构建环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建环境"}},[s._v("#")]),s._v(" 构建环境")]),s._v(" "),t("p",[t("img",{attrs:{src:a(391),alt:"image.png"}})]),s._v(" "),t("h4",{attrs:{id:"构建脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建脚本"}},[s._v("#")]),s._v(" 构建脚本")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注入 ci 构建环境 JSON")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'"GIT_BRANCH":"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$GIT_BRANCH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'","GIT_COMMIT":"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$GIT_COMMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'","GIT_COMMITTER_NAME":"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$GIT_COMMITTER_NAME")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'","GIT_URL":"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$GIT_URL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\"}'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./build-env.json\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":a;N;s/'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('//g;ta"')]),s._v(" ./build-env.json\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分支名 提取环境")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ***/master -> master")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ***/k.*** -> k")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GIT_BRANCH"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("##")]),s._v("*"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%%")]),s._v(".*}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"推送至环境：'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$var")]),s._v('"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" build\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推送文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("server")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root@nginx"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("targetDir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/share/nginx/html/'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$var")]),s._v('"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mkdir -p '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$targetDir")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" -r ./dist/* "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$targetDir")]),s._v('"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("h3",{attrs:{id:"方式2-通过-jenkins-pipeline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方式2-通过-jenkins-pipeline"}},[s._v("#")]),s._v(" 方式2：通过 Jenkins Pipeline")]),s._v(" "),t("p",[s._v("pipeline比较灵活")]),s._v(" "),t("ul",[t("li",[s._v("可以指定节点（代理），构建项目")]),s._v(" "),t("li",[s._v("可以有多个工作空间")]),s._v(" "),t("li",[s._v("可以通过将脚本写在Jenkinsfile文件，和代码一起管理")]),s._v(" "),t("li",[s._v("可以分步骤写ci/cd过程，并提供可视化，方便定位问题")]),s._v(" "),t("li",[s._v("...")])]),s._v(" "),t("h4",{attrs:{id:"构建触发器-配合-webhook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建触发器-配合-webhook"}},[s._v("#")]),s._v(" 构建触发器（配合 webHook ）")]),s._v(" "),t("p",[s._v("同自由风格")]),s._v(" "),t("h4",{attrs:{id:"流水线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#流水线"}},[s._v("#")]),s._v(" 流水线")]),s._v(" "),t("p",[s._v("脚本路径不建议修改，默认根目录下的 Jenkinsfile 就好。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(392),alt:"image.png"}})]),s._v(" "),t("h4",{attrs:{id:"编写-jenkinsfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写-jenkinsfile"}},[s._v("#")]),s._v(" 编写 Jenkinsfile")]),s._v(" "),t("p",[s._v("在根目录创建该文件，并填写如下脚本。")]),s._v(" "),t("p",[s._v("为方便读者阅读和理解，该脚本做未拆分，且 buildEnv 为几乎所有的环境变量，实际按需引用即可。")]),s._v(" "),t("div",{staticClass:"language-groovy line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-groovy"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" buildEnv "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{}'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" deployEnv "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'k'")]),s._v("\n\npipeline "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  agent any\n\n  stages "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PatchEnv'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      steps "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        script "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          buildEnv "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"""\n          {\n            \\"BRANCH_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BRANCH_NAME")]),s._v('\\",\n            \\"BRANCH_IS_PRIMARY\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BRANCH_IS_PRIMARY")]),s._v('\\",\n            \\"CHANGE_ID\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_ID")]),s._v('\\",\n            \\"CHANGE_URL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_URL")]),s._v('\\",\n            \\"CHANGE_TITLE\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_TITLE")]),s._v('\\",\n            \\"CHANGE_AUTHOR\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_AUTHOR")]),s._v('\\",\n            \\"CHANGE_AUTHOR_DISPLAY_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_AUTHOR_DISPLAY_NAME")]),s._v('\\",\n            \\"CHANGE_AUTHOR_EMAIL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_AUTHOR_EMAIL")]),s._v('\\",\n            \\"CHANGE_TARGET\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_TARGET")]),s._v('\\",\n            \\"CHANGE_BRANCH\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_BRANCH")]),s._v('\\",\n            \\"CHANGE_FORK\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CHANGE_FORK")]),s._v('\\",\n            \\"TAG_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TAG_NAME")]),s._v('\\",\n            \\"TAG_TIMESTAMP\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TAG_TIMESTAMP")]),s._v('\\",\n            \\"TAG_UNIXTIME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TAG_UNIXTIME")]),s._v('\\",\n            \\"TAG_DATE\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TAG_DATE")]),s._v('\\",\n            \\"CI\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CI")]),s._v('\\",\n            \\"BUILD_NUMBER\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILD_NUMBER")]),s._v('\\",\n            \\"BUILD_ID\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILD_ID")]),s._v('\\",\n            \\"BUILD_DISPLAY_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILD_DISPLAY_NAME")]),s._v('\\",\n            \\"JOB_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JOB_NAME")]),s._v('\\",\n            \\"JOB_BASE_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JOB_BASE_NAME")]),s._v('\\",\n            \\"BUILD_TAG\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILD_TAG")]),s._v('\\",\n            \\"EXECUTOR_NUMBER\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("EXECUTOR_NUMBER")]),s._v('\\",\n            \\"NODE_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("NODE_NAME")]),s._v('\\",\n            \\"NODE_LABELS\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("NODE_LABELS")]),s._v('\\",\n            \\"WORKSPACE\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WORKSPACE")]),s._v('\\",\n            \\"WORKSPACE_TMP\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WORKSPACE_TMP")]),s._v('\\",\n            \\"JENKINS_HOME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JENKINS_HOME")]),s._v('\\",\n            \\"JENKINS_URL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JENKINS_URL")]),s._v('\\",\n            \\"BUILD_URL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILD_URL")]),s._v('\\",\n            \\"JOB_URL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JOB_URL")]),s._v('\\",\n            \\"GIT_COMMIT\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_COMMIT")]),s._v('\\",\n            \\"GIT_PREVIOUS_COMMIT\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_PREVIOUS_COMMIT")]),s._v('\\",\n            \\"GIT_PREVIOUS_SUCCESSFUL_COMMIT\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_PREVIOUS_SUCCESSFUL_COMMIT")]),s._v('\\",\n            \\"GIT_BRANCH\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_BRANCH")]),s._v('\\",\n            \\"GIT_LOCAL_BRANCH\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_LOCAL_BRANCH")]),s._v('\\",\n            \\"GIT_CHECKOUT_DIR\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_CHECKOUT_DIR")]),s._v('\\",\n            \\"GIT_URL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_URL")]),s._v('\\",\n            \\"GIT_COMMITTER_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_COMMITTER_NAME")]),s._v('\\",\n            \\"GIT_AUTHOR_NAME\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_AUTHOR_NAME")]),s._v('\\",\n            \\"GIT_COMMITTER_EMAIL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_COMMITTER_EMAIL")]),s._v('\\",\n            \\"GIT_AUTHOR_EMAIL\\":\\"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_AUTHOR_EMAIL")]),s._v('\\"\n          }\n          """')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 保留引号的转义字符")]),s._v("\n          buildEnv "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" buildEnv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("replaceAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string regex"}},[s._v('/"/')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\\\\\\\"'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          deployEnv "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("GIT_BRANCH"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("replaceAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string regex"}},[s._v("/^.*\\//")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("replaceAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string regex"}},[s._v("/\\..*$/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"构建环境：'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("buildEnv")]),s._v('"')]),s._v("\n        echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"部署环境：'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("deployEnv")]),s._v('"')]),s._v("\n        sh "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"""\n          # 注入 ci 构建环境 JSON\n          echo "'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("buildEnv")]),s._v('" > ./build-env.json\n        """')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Build'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      steps "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nodejs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'node-16.3.0'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          sh "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"""\n            # 构建\n            yarn\n            yarn build\n          """')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Deploy'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      steps "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        sh "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"""\n          # 推送文件\n          server="root@nginx"\n          targetDir="/usr/share/nginx/html/'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("deployEnv")]),s._v('"\n\n          echo "部署目录："\n          echo \\$targetDir\n\n          ssh "\\$server" "mkdir -p \\$targetDir"\n          scp -r ./dist/* "\\$server:\\$targetDir"\n        """')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br"),t("span",{staticClass:"line-number"},[s._v("86")]),t("br"),t("span",{staticClass:"line-number"},[s._v("87")]),t("br"),t("span",{staticClass:"line-number"},[s._v("88")]),t("br"),t("span",{staticClass:"line-number"},[s._v("89")]),t("br"),t("span",{staticClass:"line-number"},[s._v("90")]),t("br"),t("span",{staticClass:"line-number"},[s._v("91")]),t("br"),t("span",{staticClass:"line-number"},[s._v("92")]),t("br"),t("span",{staticClass:"line-number"},[s._v("93")]),t("br"),t("span",{staticClass:"line-number"},[s._v("94")]),t("br"),t("span",{staticClass:"line-number"},[s._v("95")]),t("br"),t("span",{staticClass:"line-number"},[s._v("96")]),t("br"),t("span",{staticClass:"line-number"},[s._v("97")]),t("br")])]),t("h4",{attrs:{id:"jenkinsfile-编写建议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jenkinsfile-编写建议"}},[s._v("#")]),s._v(" Jenkinsfile 编写建议：")]),s._v(" "),t("ul",[t("li",[s._v("不要在 Jenkinsfile 写太多或复杂的脚本。可以通过拆分为外部 .sh 文件，来执行")]),s._v(" "),t("li",[s._v("不要将脚本揉成一团，写在一起。配合 Jenkinsfile ，拆分 stage、step ，以达到可视化的效果，如下图所示")])]),s._v(" "),t("p",[t("img",{attrs:{src:a(393),alt:"image.png"}})]),s._v(" "),t("h2",{attrs:{id:"结束语"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结束语"}},[s._v("#")]),s._v(" 结束语")]),s._v(" "),t("p",[s._v("通过阅读本文，相信你已经基本了解 Docker，并清楚 Jenkins 的运作流程，其无非就是通过 hook 或者 轮询，触发脚本。事实上 Jenkins 确实就是这样一个“小工具”，更多的还是需要靠自己编写脚本实现各种需求。\n​")]),s._v(" "),t("p",[s._v("如果你的团队每次更新代码还需要手动构建、部署，那么强烈建议用闲置的电脑，按照本文的操作实现 CI/CD ，让自己解放双手，聚焦其他更有意义的事情上。")]),s._v(" "),t("p",[s._v("最后，强烈建议继续阅读官方的两个最佳实践：")]),s._v(" "),t("ul",[t("li",[s._v("pipeline 最佳实践："),t("a",{attrs:{href:"https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("使用npm构建Node.js和React应用："),t("a",{attrs:{href:"https://www.jenkins.io/zh/doc/tutorials/build-a-node-js-and-react-app-with-npm/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.jenkins.io/zh/doc/tutorials/build-a-node-js-and-react-app-with-npm/"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);n.default=e.exports}}]);