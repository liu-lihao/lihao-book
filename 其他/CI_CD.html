<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从零开始教你用 Docker 部署 Jenkins，为你的项目实现CI/CD | 笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/lihao-book/images/favicon.ico">
    <script src="/lihao-book/js/theme.js"></script>
    <link rel="manifest" href="/lihao-book/manifest.json">
    <link rel="apple-touch-icon" href="/lihao-book/images/logo.png">
    <link rel="mask-icon" href="/lihao-book/images/egg.svg" color="#d49400">
    <meta name="description" content="在这里记下我的笔记，方便查阅">
    <meta name="theme-color" content="#d49400">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-TileImage" content="/lihao-book/images/logo.png">
    
    <link rel="preload" href="/lihao-book/assets/css/0.styles.4cb38b6f.css" as="style"><link rel="preload" href="/lihao-book/assets/js/app.12058b35.js" as="script"><link rel="preload" href="/lihao-book/assets/js/2.cc29f35f.js" as="script"><link rel="preload" href="/lihao-book/assets/js/3.3bda7e9e.js" as="script"><link rel="preload" href="/lihao-book/assets/js/13.b9e03290.js" as="script"><link rel="prefetch" href="/lihao-book/assets/js/10.ddc3aee7.js"><link rel="prefetch" href="/lihao-book/assets/js/100.65ecbf90.js"><link rel="prefetch" href="/lihao-book/assets/js/101.45034f47.js"><link rel="prefetch" href="/lihao-book/assets/js/102.21070358.js"><link rel="prefetch" href="/lihao-book/assets/js/103.81baf330.js"><link rel="prefetch" href="/lihao-book/assets/js/104.96cd59ad.js"><link rel="prefetch" href="/lihao-book/assets/js/105.830ac272.js"><link rel="prefetch" href="/lihao-book/assets/js/106.9f9b9344.js"><link rel="prefetch" href="/lihao-book/assets/js/107.ff432364.js"><link rel="prefetch" href="/lihao-book/assets/js/108.4174497b.js"><link rel="prefetch" href="/lihao-book/assets/js/109.842f600b.js"><link rel="prefetch" href="/lihao-book/assets/js/11.68340129.js"><link rel="prefetch" href="/lihao-book/assets/js/110.857ec4b0.js"><link rel="prefetch" href="/lihao-book/assets/js/111.9b284e98.js"><link rel="prefetch" href="/lihao-book/assets/js/112.f4b3c5a5.js"><link rel="prefetch" href="/lihao-book/assets/js/113.eb22d1a4.js"><link rel="prefetch" href="/lihao-book/assets/js/114.1a98bda4.js"><link rel="prefetch" href="/lihao-book/assets/js/115.924c85e2.js"><link rel="prefetch" href="/lihao-book/assets/js/116.d608aecc.js"><link rel="prefetch" href="/lihao-book/assets/js/117.c2018e31.js"><link rel="prefetch" href="/lihao-book/assets/js/118.c750f1a7.js"><link rel="prefetch" href="/lihao-book/assets/js/119.293886a9.js"><link rel="prefetch" href="/lihao-book/assets/js/12.c3ae57be.js"><link rel="prefetch" href="/lihao-book/assets/js/120.7599472e.js"><link rel="prefetch" href="/lihao-book/assets/js/121.04f2c3fd.js"><link rel="prefetch" href="/lihao-book/assets/js/122.4f5c8c8d.js"><link rel="prefetch" href="/lihao-book/assets/js/123.b0032ced.js"><link rel="prefetch" href="/lihao-book/assets/js/124.58e0ec8d.js"><link rel="prefetch" href="/lihao-book/assets/js/125.8fe136ad.js"><link rel="prefetch" href="/lihao-book/assets/js/126.21920633.js"><link rel="prefetch" href="/lihao-book/assets/js/127.ddf07f44.js"><link rel="prefetch" href="/lihao-book/assets/js/128.a4785d71.js"><link rel="prefetch" href="/lihao-book/assets/js/129.fd0b2389.js"><link rel="prefetch" href="/lihao-book/assets/js/130.59094b9e.js"><link rel="prefetch" href="/lihao-book/assets/js/131.46d8eff5.js"><link rel="prefetch" href="/lihao-book/assets/js/132.26bfa754.js"><link rel="prefetch" href="/lihao-book/assets/js/133.50966c4f.js"><link rel="prefetch" href="/lihao-book/assets/js/134.153ddd99.js"><link rel="prefetch" href="/lihao-book/assets/js/135.462c580d.js"><link rel="prefetch" href="/lihao-book/assets/js/136.781969d5.js"><link rel="prefetch" href="/lihao-book/assets/js/137.c3c0340d.js"><link rel="prefetch" href="/lihao-book/assets/js/138.06712f73.js"><link rel="prefetch" href="/lihao-book/assets/js/139.e7e2f71e.js"><link rel="prefetch" href="/lihao-book/assets/js/14.366e94dd.js"><link rel="prefetch" href="/lihao-book/assets/js/140.0b5b474d.js"><link rel="prefetch" href="/lihao-book/assets/js/141.4de7e224.js"><link rel="prefetch" href="/lihao-book/assets/js/142.bc822060.js"><link rel="prefetch" href="/lihao-book/assets/js/143.4acafd12.js"><link rel="prefetch" href="/lihao-book/assets/js/144.acb66cb0.js"><link rel="prefetch" href="/lihao-book/assets/js/145.37b585ca.js"><link rel="prefetch" href="/lihao-book/assets/js/146.bc8256aa.js"><link rel="prefetch" href="/lihao-book/assets/js/147.353f8a6c.js"><link rel="prefetch" href="/lihao-book/assets/js/148.2cca6672.js"><link rel="prefetch" href="/lihao-book/assets/js/15.11376457.js"><link rel="prefetch" href="/lihao-book/assets/js/16.2aa5f128.js"><link rel="prefetch" href="/lihao-book/assets/js/17.5a94abc0.js"><link rel="prefetch" href="/lihao-book/assets/js/18.22266ea8.js"><link rel="prefetch" href="/lihao-book/assets/js/19.9d5e202c.js"><link rel="prefetch" href="/lihao-book/assets/js/20.2bf4d527.js"><link rel="prefetch" href="/lihao-book/assets/js/21.c27c9b35.js"><link rel="prefetch" href="/lihao-book/assets/js/22.bb3a1bea.js"><link rel="prefetch" href="/lihao-book/assets/js/23.547f0af3.js"><link rel="prefetch" href="/lihao-book/assets/js/24.9eaf0e48.js"><link rel="prefetch" href="/lihao-book/assets/js/25.22b39374.js"><link rel="prefetch" href="/lihao-book/assets/js/26.51290e38.js"><link rel="prefetch" href="/lihao-book/assets/js/27.83fee76f.js"><link rel="prefetch" href="/lihao-book/assets/js/28.6f7739d1.js"><link rel="prefetch" href="/lihao-book/assets/js/29.e595daeb.js"><link rel="prefetch" href="/lihao-book/assets/js/30.15005384.js"><link rel="prefetch" href="/lihao-book/assets/js/31.68311903.js"><link rel="prefetch" href="/lihao-book/assets/js/32.c413b9b1.js"><link rel="prefetch" href="/lihao-book/assets/js/33.ebaa5e3b.js"><link rel="prefetch" href="/lihao-book/assets/js/34.93062990.js"><link rel="prefetch" href="/lihao-book/assets/js/35.84866c98.js"><link rel="prefetch" href="/lihao-book/assets/js/36.0deaf777.js"><link rel="prefetch" href="/lihao-book/assets/js/37.a31cbca4.js"><link rel="prefetch" href="/lihao-book/assets/js/38.37fdf4d2.js"><link rel="prefetch" href="/lihao-book/assets/js/39.2bdd9640.js"><link rel="prefetch" href="/lihao-book/assets/js/4.906bb4c2.js"><link rel="prefetch" href="/lihao-book/assets/js/40.7fa92507.js"><link rel="prefetch" href="/lihao-book/assets/js/41.4b4f65c2.js"><link rel="prefetch" href="/lihao-book/assets/js/42.23a78624.js"><link rel="prefetch" href="/lihao-book/assets/js/43.c748bb36.js"><link rel="prefetch" href="/lihao-book/assets/js/44.1cf59294.js"><link rel="prefetch" href="/lihao-book/assets/js/45.d6caf45f.js"><link rel="prefetch" href="/lihao-book/assets/js/46.791bcf9b.js"><link rel="prefetch" href="/lihao-book/assets/js/47.511b7135.js"><link rel="prefetch" href="/lihao-book/assets/js/48.57d40c7f.js"><link rel="prefetch" href="/lihao-book/assets/js/49.f4e50841.js"><link rel="prefetch" href="/lihao-book/assets/js/5.b9a303b4.js"><link rel="prefetch" href="/lihao-book/assets/js/50.9ced9866.js"><link rel="prefetch" href="/lihao-book/assets/js/51.2900db23.js"><link rel="prefetch" href="/lihao-book/assets/js/52.143ccb79.js"><link rel="prefetch" href="/lihao-book/assets/js/53.f906840b.js"><link rel="prefetch" href="/lihao-book/assets/js/54.71f59ac8.js"><link rel="prefetch" href="/lihao-book/assets/js/55.1ca88fd5.js"><link rel="prefetch" href="/lihao-book/assets/js/56.4f076459.js"><link rel="prefetch" href="/lihao-book/assets/js/57.7b14b934.js"><link rel="prefetch" href="/lihao-book/assets/js/58.5e884722.js"><link rel="prefetch" href="/lihao-book/assets/js/59.aa65db5e.js"><link rel="prefetch" href="/lihao-book/assets/js/6.118c529b.js"><link rel="prefetch" href="/lihao-book/assets/js/60.70f57642.js"><link rel="prefetch" href="/lihao-book/assets/js/61.8c53f226.js"><link rel="prefetch" href="/lihao-book/assets/js/62.e936d9f0.js"><link rel="prefetch" href="/lihao-book/assets/js/63.2deda3f5.js"><link rel="prefetch" href="/lihao-book/assets/js/64.6d8bdb24.js"><link rel="prefetch" href="/lihao-book/assets/js/65.99d63ab9.js"><link rel="prefetch" href="/lihao-book/assets/js/66.8bbc7b6b.js"><link rel="prefetch" href="/lihao-book/assets/js/67.d43b1be4.js"><link rel="prefetch" href="/lihao-book/assets/js/68.90caf82a.js"><link rel="prefetch" href="/lihao-book/assets/js/69.b98b72b5.js"><link rel="prefetch" href="/lihao-book/assets/js/7.ab0fbb82.js"><link rel="prefetch" href="/lihao-book/assets/js/70.f70a67d5.js"><link rel="prefetch" href="/lihao-book/assets/js/71.5c0ee5f5.js"><link rel="prefetch" href="/lihao-book/assets/js/72.bb790a69.js"><link rel="prefetch" href="/lihao-book/assets/js/73.972f8e47.js"><link rel="prefetch" href="/lihao-book/assets/js/74.c74ae0f3.js"><link rel="prefetch" href="/lihao-book/assets/js/75.63fe7d68.js"><link rel="prefetch" href="/lihao-book/assets/js/76.3f6689ca.js"><link rel="prefetch" href="/lihao-book/assets/js/77.c447bf93.js"><link rel="prefetch" href="/lihao-book/assets/js/78.8f3023d5.js"><link rel="prefetch" href="/lihao-book/assets/js/79.ee771c9d.js"><link rel="prefetch" href="/lihao-book/assets/js/8.d71d85dc.js"><link rel="prefetch" href="/lihao-book/assets/js/80.5a37dbeb.js"><link rel="prefetch" href="/lihao-book/assets/js/81.7dd62dde.js"><link rel="prefetch" href="/lihao-book/assets/js/82.d0cfbcc9.js"><link rel="prefetch" href="/lihao-book/assets/js/83.355f6b27.js"><link rel="prefetch" href="/lihao-book/assets/js/84.dcdca1de.js"><link rel="prefetch" href="/lihao-book/assets/js/85.9abd2690.js"><link rel="prefetch" href="/lihao-book/assets/js/86.3ac82bbc.js"><link rel="prefetch" href="/lihao-book/assets/js/87.edda11b9.js"><link rel="prefetch" href="/lihao-book/assets/js/88.45318fa1.js"><link rel="prefetch" href="/lihao-book/assets/js/89.9731b992.js"><link rel="prefetch" href="/lihao-book/assets/js/9.29fb7e74.js"><link rel="prefetch" href="/lihao-book/assets/js/90.c95f41fd.js"><link rel="prefetch" href="/lihao-book/assets/js/91.27f1cfd7.js"><link rel="prefetch" href="/lihao-book/assets/js/92.3462c66a.js"><link rel="prefetch" href="/lihao-book/assets/js/93.294ef7fe.js"><link rel="prefetch" href="/lihao-book/assets/js/94.0c73f5ee.js"><link rel="prefetch" href="/lihao-book/assets/js/95.679bc5b5.js"><link rel="prefetch" href="/lihao-book/assets/js/96.ececefdd.js"><link rel="prefetch" href="/lihao-book/assets/js/97.1158cc1e.js"><link rel="prefetch" href="/lihao-book/assets/js/98.3b170dee.js"><link rel="prefetch" href="/lihao-book/assets/js/99.a575163b.js">
    <link rel="stylesheet" href="/lihao-book/assets/css/0.styles.4cb38b6f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lihao-book/" class="home-link router-link-active"><img src="/lihao-book/images/logo.png" alt="笔记" class="logo"> <span class="site-name can-hide">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lihao-book/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记集合" class="dropdown-title"><span class="title">笔记集合</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记集合" class="mobile-dropdown-title"><span class="title">笔记集合</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lihao-book/JavaScript/1.JS随笔.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Vue/Vue 修饰符.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/React/1、webpack 环境搭建.html" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Nodejs/tool.html" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Koa/1. 初识 Koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Webpack/1.Webpack 入门.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/CSS/BFC.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/前端/1.HTTP缓存.html" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/数据结构和算法/二叉搜索树.html" class="nav-link">
  数据结构和算法
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/其他/CI_CD.html" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏好书" class="dropdown-title"><span class="title">收藏好书</span> <span class="arrow down"></span></button> <button type="button" aria-label="收藏好书" class="mobile-dropdown-title"><span class="title">收藏好书</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lihao-book/ES6-阮一峰/[es6]1.ECMAScript.6.简介.html" class="nav-link">
  ES6 阮一峰
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/TypeScript-xcatliu/" class="nav-link">
  TypeScript xcatliu
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="站点" class="dropdown-title"><span class="title">站点</span> <span class="arrow down"></span></button> <button type="button" aria-label="站点" class="mobile-dropdown-title"><span class="title">站点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://liu-lihao.github.io/lihao-book/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liu-lihao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lihao-book/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记集合" class="dropdown-title"><span class="title">笔记集合</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记集合" class="mobile-dropdown-title"><span class="title">笔记集合</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lihao-book/JavaScript/1.JS随笔.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Vue/Vue 修饰符.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/React/1、webpack 环境搭建.html" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Nodejs/tool.html" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Koa/1. 初识 Koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/Webpack/1.Webpack 入门.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/CSS/BFC.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/前端/1.HTTP缓存.html" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/数据结构和算法/二叉搜索树.html" class="nav-link">
  数据结构和算法
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/其他/CI_CD.html" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏好书" class="dropdown-title"><span class="title">收藏好书</span> <span class="arrow down"></span></button> <button type="button" aria-label="收藏好书" class="mobile-dropdown-title"><span class="title">收藏好书</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lihao-book/ES6-阮一峰/[es6]1.ECMAScript.6.简介.html" class="nav-link">
  ES6 阮一峰
</a></li><li class="dropdown-item"><!----> <a href="/lihao-book/TypeScript-xcatliu/" class="nav-link">
  TypeScript xcatliu
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="站点" class="dropdown-title"><span class="title">站点</span> <span class="arrow down"></span></button> <button type="button" aria-label="站点" class="mobile-dropdown-title"><span class="title">站点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://liu-lihao.github.io/lihao-book/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liu-lihao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/lihao-book/其他/CI_CD.html" class="active sidebar-link">从零开始教你用 Docker 部署 Jenkins，为你的项目实现CI/CD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#什么是ci-cd-jenkins能做什么" class="sidebar-link">什么是CI/CD，Jenkins能做什么</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#为什么用到了-docker" class="sidebar-link">为什么用到了 Docker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#docker-基本概念" class="sidebar-link">Docker 基本概念</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#docker-基本操作" class="sidebar-link">Docker 基本操作</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#docker-compose" class="sidebar-link">Docker Compose</a></li></ul></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#硬件环境" class="sidebar-link">硬件环境</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#部署-gitlab、jenkins、nginx" class="sidebar-link">部署 gitlab、jenkins、nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#部署脚本" class="sidebar-link">部署脚本</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#部署结果" class="sidebar-link">部署结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#初始化-gitlab、jenkins、nginx" class="sidebar-link">初始化 gitlab、jenkins、nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#gitlab" class="sidebar-link">gitlab</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#jenkins" class="sidebar-link">jenkins</a></li></ul></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#实现-ci-cd" class="sidebar-link">实现 CI/CD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#方式1-通过-jenkins-freestyle" class="sidebar-link">方式1：通过 Jenkins Freestyle</a></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#方式2-通过-jenkins-pipeline" class="sidebar-link">方式2：通过 Jenkins Pipeline</a></li></ul></li><li class="sidebar-sub-header"><a href="/lihao-book/其他/CI_CD.html#结束语" class="sidebar-link">结束语</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="从零开始教你用-docker-部署-jenkins-为你的项目实现ci-cd"><a href="#从零开始教你用-docker-部署-jenkins-为你的项目实现ci-cd" class="header-anchor">#</a> 从零开始教你用 Docker 部署 Jenkins，为你的项目实现CI/CD</h1> <p>本文适合尚未了解 Docker 或 Jenkins 的人群，将介绍如何使用 Docker 搭建Gilab代码仓库和Jenkins，并以前端项目、Gitlab作为代码仓库为例，实现开发人员提交代码后，根据不同分支，自动构建项目，并部署至对应环境。实际上任何项目、任意主流代码仓库（如：gitlab、github、gitee、bitbucket等）皆可。
​
阅读本文，只需要你</p> <ul><li>会使用百度（or Google）和 git 克隆、提交代码，</li> <li>了解 Web前端 的部署，是将 html 上传至 nginx 映射的目录</li> <li>了解 linux 常用操作（如：<code>cd、ls、cat、echo、ssh</code> 等 ）即可</li></ul> <h2 id="什么是ci-cd-jenkins能做什么"><a href="#什么是ci-cd-jenkins能做什么" class="header-anchor">#</a> 什么是CI/CD，Jenkins能做什么</h2> <p>实际开发中，经常会出现多分支并行开发，并需部署至多个环境，如果这些操作都有专人或者开发人员自己处理，那毫无疑问是巨大、且重复的工作量。在程序员的世界，重复的工作东西就应该自动化 ，而 Jenkins 就是为 <strong>持续构建（持续集成，CI）</strong> 、 <strong>持续部署（持续交付，CD）</strong> 的 <strong>自动化、可视化</strong> 操作提供解决方案。
​</p> <p>通俗的说，整个流程通过 【git仓库通过提交代码触发Hook通知Jenkins】或者【Jenkins 轮询扫描检查更新】等...，触发相关任务或流水线的脚本的执行。而 Jenkins 仅作为触发器、可视化的工具，相关的构建、部署都需要自行通过脚本实现。如：shell、nodejs、python 等。</p> <h2 id="为什么用到了-docker"><a href="#为什么用到了-docker" class="header-anchor">#</a> 为什么用到了 Docker</h2> <p>Docker 可以理解为 linux 的虚拟机管理工具，可以方便、快速的创建一个虚拟机（更准确是叫 <strong>容器</strong>：Docker Container），如 Alpine Linux 仅有5mb大小。
​</p> <p>将代码和一些服务，跑在同一个版本的容器中，可以 <strong>确保环境一致</strong> ，而不受硬件、机器本身操作系统影响，这在服务器迁移、分布式部署、构建等场景非常有用。换句话说，通过容器跑的项目， <strong>可以迁移、部署任意一台安装了 Docker 服务器上</strong> ，而几乎没有风险，只需要拉取同样的容器即可。
​</p> <p>Docker 既然如此重要，很有必要先简单的了解一下：（自行搜索适合自己系统安装 Docker 的方式）</p> <h3 id="docker-基本概念"><a href="#docker-基本概念" class="header-anchor">#</a> Docker 基本概念</h3> <p><img src="/lihao-book/assets/img/image.fab16997.png" alt="image.png"></p> <ul><li>宿主机从仓库 pull 一个镜像，然后 run 起来，就是一个容器（虚拟机）了</li> <li>进入容器一顿操作后，可以通过 commit 将更改留在镜像，否则容器停止后更改不会保留</li> <li>镜像可以 save 出一个文件，方便迁移</li> <li>Dockerfile 可以仅用一个文件配置的方式来定制出一个镜像，而tag文件则是一个完整的操作系统了。</li></ul> <blockquote><p>docker 默认连接的官方仓库是 <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">https://hub.docker.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，可以进入搜索 alpine 试试。</p></blockquote> <h3 id="docker-基本操作"><a href="#docker-基本操作" class="header-anchor">#</a> Docker 基本操作</h3> <p>拉取镜像 -&gt; 创建容器 -&gt; 进入容器 -&gt; 操作容器  -&gt; 删除容器 -&gt; 删除镜像</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 拉取 nginx:alpine 镜像，不带版本号默认latest最新版本，实际项目上强烈建议固定版本</span>
$ docker pull nginx:alpine
<span class="token comment"># 查看当前有哪些镜像（可以查看 IMAGE_ID 等）</span>
$ docker images
<span class="token comment"># 将镜像运行为容器</span>
<span class="token comment"># -d 后台运行</span>
<span class="token comment"># -p 8080:80 端口映射（port），前者为宿主机端口，后者为容器端口</span>
$ docker run -d -p <span class="token number">8080</span>:80 nginx

<span class="token comment"># 此时宿主机 8080 端口已经可以查看到 👉 nginx 的欢迎页。</span>

<span class="token comment"># 查看运行镜像（可以查看 CONTAINER_ID 、CONTAINER_NAME 等）</span>
$ docker <span class="token function">ps</span>
<span class="token comment"># 可以再次运行，即镜像创建第二个容器（实例，运行与第一个相互隔离，且独立的系统）</span>
<span class="token comment"># 自己准备一个 index.html 文件，然后将其目录与下方的 “/YOUR_HTML_DIR” 替换</span>
<span class="token comment"># -v /YOUR_HTML_DIR:/usr/share/nginx/html 目录映射（volume），前者为宿主机目录，后者为容器目录</span>
<span class="token comment"># --name my_html_nginx 给容器起个名字，可用来代替 CONTAINER_ID</span>
<span class="token comment"># 当然，8080 端口被占用了，这里用 8081 端口。</span>
$ docker run -d -p <span class="token number">8081</span>:80 nginx -v /YOUR_HTML_DIR:/usr/share/nginx/html --name my_html_nginx

<span class="token comment"># 此时宿主机 8081 端口已经可以查看到 👉 自己准备的 html 文件</span>

<span class="token comment"># 进入容器</span>
<span class="token comment"># my_html_nginx 为 CONTAINER_NAME</span>
<span class="token comment"># 也可以用 CONTAINER_ID, 使用任意能唯一匹配的长度即可</span>
$ docker <span class="token builtin class-name">exec</span> -it my_html_nginx <span class="token function">sh</span>
<span class="token comment"># 可以 `cd /usr/share/nginx/html` 看看自己的html文件</span>
<span class="token comment"># 当然也可以通过 vi 修改 html 文件</span>
<span class="token comment"># 退出容器</span>
$ <span class="token builtin class-name">exit</span>

<span class="token comment"># 删除容器</span>
$ docker <span class="token function">rm</span> -f /*CONTAINER_ID*/
<span class="token comment"># 删除镜像</span>
$ docker rmi -f /*IMAGE_ID*/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>如果要求容器需要自带一些自己定制的一些工具和配置，此时建议使用 <code>Dockerfile</code> 来定制构建镜像，下面举个简单的例子，感兴趣的可以去搜索相关语法。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine
<span class="token keyword">VOLUME</span> <span class="token punctuation">[</span><span class="token string">&quot;/YOUR_HTML_DIR&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/usr/share/nginx/html&quot;</span><span class="token punctuation">]</span>
<span class="token comment"># build 出镜像后，run 时，仍需 -p 指定端口映射</span>
<span class="token keyword">EXPOSE</span> 8081
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>将该 Dockerfile 写入到一个空目录。并 <code>cd</code> 到该目录 ，执行： <code>docker build -t name1:tag1 .</code>（注意后面有个点），就可以通过 <code>docker images</code> 查看到构建出的 镜像。</p> <h3 id="docker-compose"><a href="#docker-compose" class="header-anchor">#</a> Docker Compose</h3> <p>可以通过 <code>docker run</code> 跑起容器，需要大量配置参数支撑，都写成命令参数可读性非常差。此外，容器间相互通信也将成为障碍。</p> <blockquote><ol><li>为什么会有障碍？</li></ol> <p>答：Docker 网卡会为每个容器分配一个内网 ip，但是容器之间并不知道对方会被分配到什么 ip
​</p> <ol start="2"><li>上述_ Docker 基本操作 _中，第二个启动的 <code>my_html_nginx</code> 容器，能通过 <code>127.0.0.1:8080</code> 访问到第一个启动的容器吗？</li></ol> <p>答：不能，<code>127.0.0.1</code> 指向容器本身，而非宿主机，应该通过docker <strong>内网 ip</strong> 访问其 <strong>本身的端口</strong>，如 <code>172.17.0.2:80</code> ，而不是 外部的 8080。
​</p> <ol start="3"><li>怎么查看容器的被分配的内网 ip？</li></ol> <p>答：<code>ifconfig</code> or  查看hosts <code>cat /etc/hosts</code></p></blockquote> <p>那么容器与容器之间怎么通信呢？</p> <ol><li>手动查看每个容器 ip，修改每个容器 hosts【非常不实用】</li> <li>使用 <code>--link</code>，但只能单向通信：<code>run</code> 时使用 <code>--link /* CONTAINER_ID:HOST_NAME */</code> ，在这个刚起的容器内，可以通过 HOST_NAME 访问该 CONTAINER_ID 的容器，而该 CONTAINER_ID 容器，无法访问到这个刚起的容器。【非常不实用】</li> <li>通过 docker-compose 编排容器，是通过一个 yml 文件，就能运行多个容器的神器。其会自动的将定义容器的 <code>key</code> 值，作为每个容器的域名映射。当然了，docker-compose 需自行搜索安装方式。</li></ol> <p>下面举个简单的例子，<code>nginx01</code> 和 <code>nginx02</code> 作为容器的 <code>key</code> 值。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx01</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mynginx01
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">80</span>
  <span class="token key atrule">nginx02</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mynginx02
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8081<span class="token punctuation">:</span><span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 将上述配置保存为 docker-compose.yml 文件，并cd到该目录</span>
<span class="token comment"># 启动 docker-compose ，up 启动，-d 是后台运行</span>
$ docker-compose up -d
<span class="token comment"># 进入容器 mynginx02</span>
$ docker <span class="token builtin class-name">exec</span> -it mynginx02 <span class="token function">sh</span>
<span class="token comment"># 如果没有 curl ，则执行 apk add curl</span>
<span class="token comment"># 如果有就尝试连接一下</span>
<span class="token comment"># 可以看到返回一个 nginx01 的欢迎页</span>
$ <span class="token function">curl</span> nginx02:80
<span class="token comment"># 注意不是 8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​
到此，相信你已经基本会使用 Docker、docker-compose 了，下面回到主题</p> <h2 id="硬件环境"><a href="#硬件环境" class="header-anchor">#</a> 硬件环境</h2> <p>理论上，需要三台服务器。但因为笔者资金有限，仅有一台电脑，通过三个 Docker 容器（虚拟机），代替三台服务器
三台服务器的作用是分别部署：</p> <ul><li>gitlab：代码仓库</li> <li>jenkins：主流的 CI/CD 工具</li> <li>nginx：作为项目部署的服务器，此处用不同目录代表不同环境（模拟实际项目上，不同环境对应不同服务器）。</li></ul> <p>笔者电脑：win10 20H2 wsl2 Ubuntu 20.04.2 LTS、Docker version 20.10.6、docker-compose version 1.29.2（硬件要求：内存16g以上，其余环境只要有了docker，就无所谓了）</p> <h2 id="部署-gitlab、jenkins、nginx"><a href="#部署-gitlab、jenkins、nginx" class="header-anchor">#</a> 部署 gitlab、jenkins、nginx</h2> <h3 id="部署脚本"><a href="#部署脚本" class="header-anchor">#</a> 部署脚本</h3> <p>使用docker，分别创建三台服务器，并且这三台服务器之间还需要通信，所以用到 docker-compose 来编排容器。（如果你有三台服务器，则可分开部署，通过服务器之间通过内网ip访问即可）</p> <p>创建脚本如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>version: <span class="token string">&quot;3&quot;</span>
services:
  nginx:
    container_name: mynginx
    image: nginx:alpine
    ports:
      - <span class="token number">80</span>:80
      - <span class="token string">&quot;8022:22&quot;</span>
    volumes:
      - /home/vito/project:/usr/share/nginx/html
      - /home/vito/docker_nginx_data/log:/var/log/nginx
      <span class="token comment"># 按需配置，如果你了解 nginx 的话</span>
      <span class="token comment"># - /home/vito/docker_nginx_data/nginx.conf:/etc/nginx/nginx.conf</span>
      <span class="token comment"># - /home/vito/docker_nginx_data/conf.d/default.conf:/etc/nginx/conf.d/default.conf</span>
    command:
      - /bin/sh
      - -c
      - <span class="token operator">|</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;http://mirrors.aliyun.com/alpine/v3.8/main/&quot;</span> <span class="token operator">&gt;</span> /etc/apk/repositories
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;http://mirrors.aliyun.com/alpine/v3.8/community/&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/apk/repositories
        apk update
        apk <span class="token function">add</span> --no-cache openssh openrc tzdata
        <span class="token function">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        <span class="token function">sed</span> -i <span class="token string">&quot;s/#PermitRootLogin.*/PermitRootLogin yes/g&quot;</span> /etc/ssh/sshd_config
        <span class="token function">mkdir</span> -p /root/.ssh <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> <span class="token number">700</span> /root/.ssh/
        ssh-keygen -A
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;root:root&quot;</span> <span class="token operator">|</span> chpasswd
        apk del tzdata
        <span class="token function">rm</span> -rf /var/cache/apk/*
        /usr/sbin/sshd
        nginx
        nginx -s reload
        <span class="token function">tail</span> -f /dev/null
  gitlab:
    container_name: mygitlab
    image: gitlab/gitlab-ce:latest
    ports:
      - <span class="token number">6490</span>:80
      - <span class="token number">6492</span>:443
    privileged: <span class="token boolean">true</span>
    volumes:
      - /home/vito/docker_gitlab_data/etc:/etc/gitlab
      - /home/vito/docker_gitlab_data/log:/var/log/gitlab
      - /home/vito/docker_gitlab_data/opt:/var/opt/gitlab
  jenkins:
    container_name: myjenkins
    image: jenkins/jenkins:lts
    ports:
      - <span class="token number">6480</span>:8080
      - <span class="token number">6481</span>:50000
      - <span class="token number">6482</span>:45000
    volumes:
      - /home/vito/docker_jenkins_data:/var/jenkins_home
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>保存为 <code>docker-compose.yml</code> 文件，通过 <code>docker-compose up -d</code> 启动。
<strong>注意</strong>：</p> <ol><li><code>8022:22</code> 需要加上引号，不然和yml语法有冲突</li> <li>nginx command 会覆盖原命令，所以在安装、运行ssh后，还需要重启nginx</li> <li>安装ssh，明文在脚本写了&quot;root:root&quot; (用户名:密码)，虽然不太对，但这里仅用来学习，且作为测试环境服务器</li></ol> <h3 id="部署结果"><a href="#部署结果" class="header-anchor">#</a> 部署结果</h3> <p>项目分别部署在（根据端口映射，且需要在宿主机补充一个页面，/home/vito/project/k/index.html）：</p> <ul><li>Ngnix 前端项目：<a href="http://127.0.0.1/k/index.html" target="_blank" rel="noopener noreferrer">http://127.0.0.1/k/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Gitlab: <a href="http://127.0.0.1:6490" target="_blank" rel="noopener noreferrer">http://127.0.0.1:6490<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Jenkins: <a href="http://127.0.0.1:6480" target="_blank" rel="noopener noreferrer">http://127.0.0.1:6480<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="初始化-gitlab、jenkins、nginx"><a href="#初始化-gitlab、jenkins、nginx" class="header-anchor">#</a> 初始化 gitlab、jenkins、nginx</h2> <p>打开 Gitlab、Jenkins 瞧一瞧，该设密码就设密码，该创建账户就创建，根据 UI 提示操作即可。
这里需要<strong>注意</strong></p> <ul><li>gitlab初始账户名称是：root</li> <li>jenkins安装 <strong>推荐插件</strong></li></ul> <h3 id="gitlab"><a href="#gitlab" class="header-anchor">#</a> gitlab</h3> <h4 id="初始化项目代码"><a href="#初始化项目代码" class="header-anchor">#</a> 初始化项目代码</h4> <p>此处需要您创建了一个 test-vite 的项目：<code>ssh://git@127.0.*.*:***/test/test-vite.git</code></p> <p>并通过 <code>yarn create @vitejs/app</code> 初始化了前端代码</p> <h4 id="webhook请求配置"><a href="#webhook请求配置" class="header-anchor">#</a> webhook请求配置</h4> <p>使用root账户进行设置（如果你将gitlab部署到另一台服务器，这里就可以略过了）：</p> <p><img src="/lihao-book/assets/img/image2.560710c1.png" alt="image.png">
​</p> <h3 id="jenkins"><a href="#jenkins" class="header-anchor">#</a> jenkins</h3> <h4 id="插件安装"><a href="#插件安装" class="header-anchor">#</a> 插件安装</h4> <p>手动搜索安装：</p> <ul><li>gitlab</li> <li>nodejs</li></ul> <h4 id="系统设置"><a href="#系统设置" class="header-anchor">#</a> 系统设置</h4> <p>系统设置 - 系统配置</p> <ul><li><strong>取消打勾 Gitlab：Enable authentication for '/project' end-point</strong></li></ul> <p>系统设置 - 全局工具配置</p> <ul><li><strong>安装Nodejs。Global npm packages to install 此处可以填写 yarn（根据项目来，也可以不填，手动通过npm安装）</strong></li></ul> <h4 id="配置-gitlab-拉取代码权限认证"><a href="#配置-gitlab-拉取代码权限认证" class="header-anchor">#</a> 配置 gitlab 拉取代码权限认证</h4> <p>当然了，此时的 jenkins 肯定是匿名，没有权限拉取代码的。分别给 jenkins、gitlab 配个 ssh 私钥、公钥即可。</p> <p><img src="/lihao-book/assets/img/image3.4be9836e.png" alt="image.png"></p> <h4 id="生成公钥、私钥"><a href="#生成公钥、私钥" class="header-anchor">#</a> 生成公钥、私钥</h4> <p>进入jenkins容器，使用root账号生成：<code>ssh-keygen -t rsa</code></p> <p>一路回车，进入提示的目录就可以看到，两个文件：</p> <ul><li>id_rsa 私钥</li> <li>id_rsa.pub 公钥</li></ul> <p>分别 <code>cat</code> 出来，并复制。</p> <h5 id="配置公钥"><a href="#配置公钥" class="header-anchor">#</a> 配置公钥</h5> <p>gitlab -&gt; 头像 -&gt; preferences -&gt; ssh 密钥 -&gt; 粘贴公钥 -&gt; 添加密钥</p> <h5 id="配置私钥"><a href="#配置私钥" class="header-anchor">#</a> 配置私钥</h5> <p>jenkins -&gt; 系统管理 -&gt; 凭据管理（Manage Credentails，不是凭据配置） -&gt; 添加全局凭据 -&gt; 选择 SSH... -&gt; 如图</p> <p><img src="/lihao-book/assets/img/image4.7d5a3721.png" alt="image.png"></p> <h4 id="配置-nginx-推送文件的-ssh-免密"><a href="#配置-nginx-推送文件的-ssh-免密" class="header-anchor">#</a> 配置 nginx 推送文件的 ssh 免密</h4> <p>用于 jenkins 执行推送文件脚本，同步文件到nginx服务器上。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 进入jenkins</span>
docker <span class="token builtin class-name">exec</span> -it myjenkins <span class="token function">sh</span>

<span class="token comment"># 进入后</span>

<span class="token comment"># 1、生成公钥、私钥</span>
<span class="token comment">#    一路回车</span>
ssh-keygen

<span class="token comment"># 2、添加公钥，这里需要输入ngnix服务器的密码，就是上方脚本里头的root:root，前者为用户名，后者为密码。</span>
ssh-copy-id -i ~/.ssh/id_rsa.pub root@nginx

<span class="token comment"># 完成免密，测试</span>
<span class="token function">ssh</span> root@nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>补充知识：ssh默认会连22端口，对于本来就暴露22端口的nginx容器来说无需配置，而对于外部的宿主机就需要指定映射的端口：<code>ssh root@127.0.0.1 -p8022</code></p></blockquote> <h2 id="实现-ci-cd"><a href="#实现-ci-cd" class="header-anchor">#</a> 实现 CI/CD</h2> <p>下面介绍Jenkins创建项目中最常用的两种方式，其中主流还是 pipeline。</p> <h3 id="方式1-通过-jenkins-freestyle"><a href="#方式1-通过-jenkins-freestyle" class="header-anchor">#</a> 方式1：通过 Jenkins Freestyle</h3> <p>自由风格非常简单：jenkins提供一个工作空间，通过ui配置shell</p> <h4 id="源码配置"><a href="#源码配置" class="header-anchor">#</a> 源码配置：</h4> <ul><li>源码地址ip需替换为映射地址</li> <li>Credentials 凭证，选取刚刚配置好的</li></ul> <p><img src="/lihao-book/assets/img/image5.37f6c7ce.png" alt="image.png"></p> <h4 id="构建触发器-配合webhook"><a href="#构建触发器-配合webhook" class="header-anchor">#</a> 构建触发器（配合webHook）：</h4> <p>生成hook密钥，此时需要复制出：第一个红框的项目地址，以及生成的token。</p> <p><img src="/lihao-book/assets/img/image6.5ed76eb3.png" alt="image.png"></p> <p>进入Gitlab test-vite 项目中：</p> <p><strong>注意</strong>：项目地址ip需替换为映射地址：http://jenkins:8080/project/FE/gitlab-test-01</p> <p><img src="/lihao-book/assets/img/image7.d5f5f564.png" alt="image.png"></p> <p><img src="/lihao-book/assets/img/image8.8e7e8810.png" alt="image.png"></p> <h4 id="构建环境"><a href="#构建环境" class="header-anchor">#</a> 构建环境</h4> <p><img src="/lihao-book/assets/img/image9.c8be8362.png" alt="image.png"></p> <h4 id="构建脚本"><a href="#构建脚本" class="header-anchor">#</a> 构建脚本</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 注入 ci 构建环境 JSON</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;{&quot;</span> <span class="token operator">&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token string">'&quot;GIT_BRANCH&quot;:&quot;'</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token variable">$GIT_BRANCH</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token string">'&quot;,&quot;GIT_COMMIT&quot;:&quot;'</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token variable">$GIT_COMMIT</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token string">'&quot;,&quot;GIT_COMMITTER_NAME&quot;:&quot;'</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token variable">$GIT_COMMITTER_NAME</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token string">'&quot;,&quot;GIT_URL&quot;:&quot;'</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token variable">$GIT_URL</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token builtin class-name">echo</span> <span class="token string">'&quot;}'</span> <span class="token operator">&gt;&gt;</span> ./build-env.json
<span class="token function">sed</span> -i <span class="token string">&quot;:a;N;s/<span class="token entity" title="\n">\n</span>//g;ta&quot;</span> ./build-env.json

<span class="token comment"># 分支名 提取环境</span>
<span class="token comment"># ***/master -&gt; master</span>
<span class="token comment"># ***/k.*** -&gt; k</span>
<span class="token assign-left variable">var</span><span class="token operator">=</span><span class="token variable">${GIT_BRANCH<span class="token operator">##</span>*<span class="token operator">/</span>}</span>
<span class="token assign-left variable">var</span><span class="token operator">=</span><span class="token variable">${var<span class="token operator">%%</span>.*}</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;推送至环境：<span class="token variable">$var</span>&quot;</span>

<span class="token comment"># 构建</span>
<span class="token function">yarn</span>
<span class="token function">yarn</span> build

<span class="token comment"># 推送文件</span>
<span class="token assign-left variable">server</span><span class="token operator">=</span><span class="token string">&quot;root@nginx&quot;</span>
<span class="token assign-left variable">targetDir</span><span class="token operator">=</span><span class="token string">&quot;/usr/share/nginx/html/<span class="token variable">$var</span>&quot;</span>

<span class="token function">ssh</span> <span class="token string">&quot;<span class="token variable">$server</span>&quot;</span> <span class="token string">&quot;mkdir -p <span class="token variable">$targetDir</span>&quot;</span>
<span class="token function">scp</span> -r ./dist/* <span class="token string">&quot;<span class="token variable">$server</span>:<span class="token variable">$targetDir</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="方式2-通过-jenkins-pipeline"><a href="#方式2-通过-jenkins-pipeline" class="header-anchor">#</a> 方式2：通过 Jenkins Pipeline</h3> <p>pipeline比较灵活</p> <ul><li>可以指定节点（代理），构建项目</li> <li>可以有多个工作空间</li> <li>可以通过将脚本写在Jenkinsfile文件，和代码一起管理</li> <li>可以分步骤写ci/cd过程，并提供可视化，方便定位问题</li> <li>...</li></ul> <h4 id="构建触发器-配合-webhook"><a href="#构建触发器-配合-webhook" class="header-anchor">#</a> 构建触发器（配合 webHook ）</h4> <p>同自由风格</p> <h4 id="流水线"><a href="#流水线" class="header-anchor">#</a> 流水线</h4> <p>脚本路径不建议修改，默认根目录下的 Jenkinsfile 就好。</p> <p><img src="/lihao-book/assets/img/image10.aaf010e2.png" alt="image.png"></p> <h4 id="编写-jenkinsfile"><a href="#编写-jenkinsfile" class="header-anchor">#</a> 编写 Jenkinsfile</h4> <p>在根目录创建该文件，并填写如下脚本。</p> <p>为方便读者阅读和理解，该脚本做未拆分，且 buildEnv 为几乎所有的环境变量，实际按需引用即可。</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token keyword">def</span> buildEnv <span class="token operator">=</span> <span class="token string">'{}'</span>
<span class="token keyword">def</span> deployEnv <span class="token operator">=</span> <span class="token string">'k'</span>

pipeline <span class="token punctuation">{</span>

  agent any

  stages <span class="token punctuation">{</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'PatchEnv'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      steps <span class="token punctuation">{</span>
        script <span class="token punctuation">{</span>
          buildEnv <span class="token operator">=</span> <span class="token string gstring">&quot;&quot;&quot;
          {
            \&quot;BRANCH_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BRANCH_NAME</span>\&quot;,
            \&quot;BRANCH_IS_PRIMARY\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BRANCH_IS_PRIMARY</span>\&quot;,
            \&quot;CHANGE_ID\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_ID</span>\&quot;,
            \&quot;CHANGE_URL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_URL</span>\&quot;,
            \&quot;CHANGE_TITLE\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_TITLE</span>\&quot;,
            \&quot;CHANGE_AUTHOR\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_AUTHOR</span>\&quot;,
            \&quot;CHANGE_AUTHOR_DISPLAY_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_AUTHOR_DISPLAY_NAME</span>\&quot;,
            \&quot;CHANGE_AUTHOR_EMAIL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_AUTHOR_EMAIL</span>\&quot;,
            \&quot;CHANGE_TARGET\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_TARGET</span>\&quot;,
            \&quot;CHANGE_BRANCH\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_BRANCH</span>\&quot;,
            \&quot;CHANGE_FORK\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CHANGE_FORK</span>\&quot;,
            \&quot;TAG_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>TAG_NAME</span>\&quot;,
            \&quot;TAG_TIMESTAMP\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>TAG_TIMESTAMP</span>\&quot;,
            \&quot;TAG_UNIXTIME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>TAG_UNIXTIME</span>\&quot;,
            \&quot;TAG_DATE\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>TAG_DATE</span>\&quot;,
            \&quot;CI\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>CI</span>\&quot;,
            \&quot;BUILD_NUMBER\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BUILD_NUMBER</span>\&quot;,
            \&quot;BUILD_ID\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BUILD_ID</span>\&quot;,
            \&quot;BUILD_DISPLAY_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BUILD_DISPLAY_NAME</span>\&quot;,
            \&quot;JOB_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>JOB_NAME</span>\&quot;,
            \&quot;JOB_BASE_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>JOB_BASE_NAME</span>\&quot;,
            \&quot;BUILD_TAG\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BUILD_TAG</span>\&quot;,
            \&quot;EXECUTOR_NUMBER\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>EXECUTOR_NUMBER</span>\&quot;,
            \&quot;NODE_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>NODE_NAME</span>\&quot;,
            \&quot;NODE_LABELS\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>NODE_LABELS</span>\&quot;,
            \&quot;WORKSPACE\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>WORKSPACE</span>\&quot;,
            \&quot;WORKSPACE_TMP\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>WORKSPACE_TMP</span>\&quot;,
            \&quot;JENKINS_HOME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>JENKINS_HOME</span>\&quot;,
            \&quot;JENKINS_URL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>JENKINS_URL</span>\&quot;,
            \&quot;BUILD_URL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>BUILD_URL</span>\&quot;,
            \&quot;JOB_URL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>JOB_URL</span>\&quot;,
            \&quot;GIT_COMMIT\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_COMMIT</span>\&quot;,
            \&quot;GIT_PREVIOUS_COMMIT\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_PREVIOUS_COMMIT</span>\&quot;,
            \&quot;GIT_PREVIOUS_SUCCESSFUL_COMMIT\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_PREVIOUS_SUCCESSFUL_COMMIT</span>\&quot;,
            \&quot;GIT_BRANCH\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_BRANCH</span>\&quot;,
            \&quot;GIT_LOCAL_BRANCH\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_LOCAL_BRANCH</span>\&quot;,
            \&quot;GIT_CHECKOUT_DIR\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_CHECKOUT_DIR</span>\&quot;,
            \&quot;GIT_URL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_URL</span>\&quot;,
            \&quot;GIT_COMMITTER_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_COMMITTER_NAME</span>\&quot;,
            \&quot;GIT_AUTHOR_NAME\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_AUTHOR_NAME</span>\&quot;,
            \&quot;GIT_COMMITTER_EMAIL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_COMMITTER_EMAIL</span>\&quot;,
            \&quot;GIT_AUTHOR_EMAIL\&quot;:\&quot;<span class="token expression"><span class="token punctuation">$</span>env<span class="token punctuation">.</span>GIT_AUTHOR_EMAIL</span>\&quot;
          }
          &quot;&quot;&quot;</span>
          <span class="token comment">// 保留引号的转义字符</span>
          buildEnv <span class="token operator">=</span> buildEnv<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string regex">/&quot;/</span><span class="token punctuation">,</span> <span class="token string">'\\\\&quot;'</span><span class="token punctuation">)</span>
          deployEnv <span class="token operator">=</span> env<span class="token punctuation">.</span>GIT_BRANCH<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string regex">/^.*\//</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string regex">/\..*$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        echo <span class="token string gstring">&quot;构建环境：<span class="token expression"><span class="token punctuation">$</span>buildEnv</span>&quot;</span>
        echo <span class="token string gstring">&quot;部署环境：<span class="token expression"><span class="token punctuation">$</span>deployEnv</span>&quot;</span>
        sh <span class="token string gstring">&quot;&quot;&quot;
          # 注入 ci 构建环境 JSON
          echo &quot;<span class="token expression"><span class="token punctuation">$</span>buildEnv</span>&quot; &gt; ./build-env.json
        &quot;&quot;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      steps <span class="token punctuation">{</span>
        <span class="token function">nodejs</span><span class="token punctuation">(</span><span class="token string">'node-16.3.0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sh <span class="token string gstring">&quot;&quot;&quot;
            # 构建
            yarn
            yarn build
          &quot;&quot;&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      steps <span class="token punctuation">{</span>
        sh <span class="token string gstring">&quot;&quot;&quot;
          # 推送文件
          server=&quot;root@nginx&quot;
          targetDir=&quot;/usr/share/nginx/html/<span class="token expression"><span class="token punctuation">$</span>deployEnv</span>&quot;

          echo &quot;部署目录：&quot;
          echo \$targetDir

          ssh &quot;\$server&quot; &quot;mkdir -p \$targetDir&quot;
          scp -r ./dist/* &quot;\$server:\$targetDir&quot;
        &quot;&quot;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h4 id="jenkinsfile-编写建议"><a href="#jenkinsfile-编写建议" class="header-anchor">#</a> Jenkinsfile 编写建议：</h4> <ul><li>不要在 Jenkinsfile 写太多或复杂的脚本。可以通过拆分为外部 .sh 文件，来执行</li> <li>不要将脚本揉成一团，写在一起。配合 Jenkinsfile ，拆分 stage、step ，以达到可视化的效果，如下图所示</li></ul> <p><img src="/lihao-book/assets/img/image11.a2d52708.png" alt="image.png"></p> <h2 id="结束语"><a href="#结束语" class="header-anchor">#</a> 结束语</h2> <p>通过阅读本文，相信你已经基本了解 Docker，并清楚 Jenkins 的运作流程，其无非就是通过 hook 或者 轮询，触发脚本。事实上 Jenkins 确实就是这样一个“小工具”，更多的还是需要靠自己编写脚本实现各种需求。
​</p> <p>如果你的团队每次更新代码还需要手动构建、部署，那么强烈建议用闲置的电脑，按照本文的操作实现 CI/CD ，让自己解放双手，聚焦其他更有意义的事情上。</p> <p>最后，强烈建议继续阅读官方的两个最佳实践：</p> <ul><li>pipeline 最佳实践：<a href="https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/" target="_blank" rel="noopener noreferrer">https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>使用npm构建Node.js和React应用：<a href="https://www.jenkins.io/zh/doc/tutorials/build-a-node-js-and-react-app-with-npm/" target="_blank" rel="noopener noreferrer">https://www.jenkins.io/zh/doc/tutorials/build-a-node-js-and-react-app-with-npm/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/7/24 上午8:09:34</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/lihao-book/assets/js/app.12058b35.js" defer></script><script src="/lihao-book/assets/js/2.cc29f35f.js" defer></script><script src="/lihao-book/assets/js/3.3bda7e9e.js" defer></script><script src="/lihao-book/assets/js/13.b9e03290.js" defer></script>
  </body>
</html>
